#!/bin/sh -eux

# A Weave Cloud user is usually expect to install the agents using one simple command like this:
#   kubectl create -n kube-system 'https://cloud.weave.works/k8s/v1.6/weave-cloud?t=<service_token>'
#
# There is service that generates manifest based on the parameters passed in the URL.
# This chart simply checks-in the YAML manifest generated by the service, and this script is used to
# update the chart.

REPLACE_SERVICE_TOKEN='{{required "Weave Cloud token is missing, please make sure ServiceToken value is provided" .Values.ServiceToken}}'

for manifest in flux scope cortex ; do
  curl --silent --location \
    --get "http://localhost:8080/k8s/v1.6/${manifest}" \
    --data-urlencode "service-token=%{REPLACE_SERVICE_TOKEN}" \
    --data-urlencode "omit-support-info=true" \
    --output "./templates/${manifest}.yaml"
  gsed "s/%{REPLACE_SERVICE_TOKEN}/${REPLACE_SERVICE_TOKEN}/" -i "./templates/${manifest}.yaml"
done
